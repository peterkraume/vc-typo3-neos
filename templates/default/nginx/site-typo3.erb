server {
  listen          80;
  server_name     <%= @vhost_name %>;
  root            /var/www/<%= @vhost_name %>/Web;
  index           index.php;
  
  access_log      <%= node['nginx']['log_dir'] %>/<%= @vhost_name %>.access.log;
  error_log       <%= node['nginx']['log_dir'] %>/<%= @vhost_name %>.error.log;
    
  location / {
    try_files $uri /index.php?$args;
  }
  
  location ~ "^/_Resources/Persistent/" {
    access_log off;
    expires max;
    rewrite "(.{40})/.+\.(.+)"                        /_Resources/Persistent/$1.$2 break;
    rewrite "([a-z0-9]+/(.+/)?[a-f0-9]{40})/.+\.(.+)" /_Resources/Persistent/$1.$2 break;
  }
  
  location ~ \.php$ {
    include         fastcgi_params;
    fastcgi_param   FLOW_CONTEXT        Development; # Development|Production
    fastcgi_param   FLOW_REWRITEURLS    1;
    fastcgi_pass    upstream-php;
  }
  
  include include-security.conf;
  include include-common.conf;
  include include-static.conf;
}

# Redirect from www. prefixed host to non-www variant
server {
  listen        80;
  server_name   www.<%= @vhost_name %>;
  rewrite     ^ http://<%= @vhost_name %>$request_uri? permanent;
  expires max;
}
